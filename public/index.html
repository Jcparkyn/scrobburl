<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <link rel="stylesheet" href="main.css">
  <script src="main.js"></script>
  <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
  <meta name="viewport" content="width=device-width, height=100vh, initial-scale=1.0, maximum-scale=1.0, user-scalable=, interactive-widget=resizes-content" />
</head>
<body>
  <div id="myapp">Fetching dictionary...</div>
  <script>
    customElements.define('scroll-repeat', class extends HTMLElement {
      constructor() { super(); }
      connectedCallback() {
        let dragStart = null;
        const elem = this.firstChild;
        const scrollResetDistance = (55 + 4) * 14;
        const mod = (a, b) => ((a % b) + b) % b;
        const normalize = (n) => mod(n, scrollResetDistance) - scrollResetDistance
        const panzoom = Panzoom(elem, {
          minScale: 0.6,
          maxScale: 2,
          canvas: false,
          step: 0.3,
          noBind: true,
          setTransform: (elem, { x, y, scale }) => {
            panzoom.setStyle('transform', `scale(${scale}) translate(${normalize(x)}px, ${normalize(y)}px)`);
          },
        });
        elem.addEventListener('pointerdown', (event) => {
          dragStart = { x: event.clientX, y: event.clientY };
          panzoom.handleDown(event);
        })
        document.addEventListener('pointermove', panzoom.handleMove);
        document.addEventListener('pointerup', panzoom.handleUp);
        this.addEventListener('wheel', panzoom.zoomWithWheel);
        // ignore clicks in child elements if the pointer moved
        this.addEventListener("click", e => {
          if (dragStart != null) {
            const srqDist = Math.pow(e.clientX - dragStart.x, 2) + Math.pow(e.clientY - dragStart.y, 2);
            if (srqDist > 2) {
              e.preventDefault();
              e.stopPropagation();
            }
          }
        }, { capture: true});
      }
    });
    const start = async () => {
      const wordlist = await fetch('dictionary.txt').then(res => res.text());
      // This seed isn't perfect, but it doesn't matter too much
      const seed = Math.floor(Math.random() * Number.MAX_SAFE_INTEGER);
      const app = Elm.Main.init({
        node: document.getElementById('myapp'),
        flags: {
          wordlist,
          initialSeed: seed,
        }
      });
    }
    start();
  </script>
</body>
</html>